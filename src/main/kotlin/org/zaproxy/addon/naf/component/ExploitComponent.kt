package org.zaproxy.addon.naf.component

import androidx.compose.runtime.snapshots.SnapshotStateList
import com.arkivanov.decompose.ComponentContext
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.update
import kotlinx.coroutines.launch
import me.d3s34.commix.CommixRequest
import me.d3s34.lfi.LfiExploiter
import me.d3s34.sqlmap.restapi.request.StartTaskRequest
import me.d3s34.tplmap.TplmapRequest
import org.parosproxy.paros.control.Control
import org.parosproxy.paros.model.HistoryReference
import org.zaproxy.addon.naf.NafService
import org.zaproxy.addon.naf.component.exploit.*
import org.zaproxy.addon.naf.model.*
import org.zaproxy.zap.extension.alert.ExtensionAlert
import java.nio.charset.Charset
import kotlin.coroutines.CoroutineContext
import kotlin.reflect.KClass

class ExploitComponent(
    componentContext: ComponentContext,
    val nafService: NafService,
    val listExploitTabComponent: SnapshotStateList<ExploitTabComponent>,
    override val coroutineContext: CoroutineContext
): ComponentContext by componentContext, CoroutineScope {

    private val extensionAlert by lazy {
        Control
            .getSingleton()
            .extensionLoader
            .getExtension(ExtensionAlert::class.java)
    }

    val lfiExploiter by lazy {
        LfiExploiter()
    }

    val currentIndex = MutableStateFlow(0)

    fun handleExploitEvent(event: ExploitEvent) {
        val historyRef = getHistoryRef(event.alert)

        when (event) {
            is SqlInjectionEvent -> {
                val sqlmapTabComponent = SqlmapTabComponent(nafService.sqlmapEngine!!)

                historyRef?.let {
                    sqlmapTabComponent.startRequestState.value = StartTaskRequest(
                        url = historyRef.uri.toString(),
                        data = historyRef.httpMessage.requestBody.content.toString(Charset.defaultCharset()),
                        cookie = historyRef.httpMessage.cookieParamsAsString
                    )
                }

                listExploitTabComponent
                    .add(sqlmapTabComponent)

                currentIndex.update {
                    listExploitTabComponent.lastIndex
                }
            }
            is CommandInjectionEvent -> {

                val commixTabComponent = CommixTabComponent(nafService.commixDockerEngine!!, this)


                historyRef?.let {
                    commixTabComponent.commixRequest.value = CommixRequest(
                        url = historyRef.uri.toString(),
                        data = historyRef.httpMessage.requestBody.content.toString(Charset.defaultCharset()),
                        cookies = historyRef.httpMessage.cookieParamsAsString
                    )
                }

                listExploitTabComponent
                    .add(commixTabComponent)

                currentIndex.update {
                    listExploitTabComponent.lastIndex
                }
            }
            is TemplateInjectionEvent -> {
                val tplmapTabComponent = TplmapTabComponent(nafService.tplmapDockerEngine!!, this)
                historyRef?.let {
                    tplmapTabComponent.tplmapRequest.value = TplmapRequest(
                        url = historyRef.uri.toString(),
                        data = historyRef.httpMessage.requestBody.content.toString(Charset.defaultCharset()),
                        cookies = historyRef.httpMessage.cookieParamsAsString,
                        osShell = true
                    )
                }

                listExploitTabComponent.add(tplmapTabComponent)

                currentIndex.update {
                    listExploitTabComponent.lastIndex
                }
            }
        }
    }

    private fun getHistoryRef(nafAlert: NafAlert): HistoryReference? {
        return extensionAlert
            .allAlerts
            .firstOrNull { it.alertId == nafAlert.id.toInt() }
            ?.historyRef
    }

    fun createNewTab(tab: KClass<out ExploitTabComponent>): ExploitTabComponent {
        return when (tab) {
            SqlmapTabComponent::class -> {
                SqlmapTabComponent(sqlmapEngine = nafService.sqlmapEngine!!)
            }
            CommixTabComponent::class -> {
                CommixTabComponent(
                    commixDockerEngine = nafService.commixDockerEngine!!,
                    coroutineScope = this
                )
            }
            TplmapTabComponent::class -> {
                TplmapTabComponent(
                    tplmapDockerEngine = nafService.tplmapDockerEngine!!,
                    coroutineScope = this
                )
            }
            LfiTabComponent::class -> {
                LfiTabComponent(
                    lfiExploiter = lfiExploiter
                )
            }
            else -> { StartTabComponent() }
        }
    }

    fun startAttack(index: Int) {
        launch {
            listExploitTabComponent[index].exploit()
        }
    }
}
