package org.zaproxy.addon.naf.component

import androidx.compose.runtime.mutableStateListOf
import com.arkivanov.decompose.ComponentContext
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.launch
import org.parosproxy.paros.control.Control
import org.parosproxy.paros.extension.history.ExtensionHistory
import org.zaproxy.addon.naf.NafService
import org.zaproxy.addon.naf.model.*
import kotlin.coroutines.CoroutineContext
import kotlin.reflect.KClass

class ExploitComponent(
    componentContext: ComponentContext,
    val nafService: NafService,
    override val coroutineContext: CoroutineContext
): ComponentContext by componentContext, CoroutineScope {

    val listExploitTab = mutableStateListOf<ExploitTab>(StartTab())

    private val extensionHistory: ExtensionHistory by lazy {
        Control
            .getSingleton()
            .extensionLoader
            .getExtension(ExtensionHistory::class.java)
    }

    fun handleExploitEvent(event: ExploitEvent) {
        when (event) {
            is SqlInjectionEvent -> {

            }
        }
    }

    fun createNewTab(tab: KClass<out ExploitTab>): ExploitTab {
        return when (tab) {
            SqlmapTab::class -> { SqlmapTab(sqlmapEngine = nafService.sqlmapEngine!!) }
            CommixTab::class -> { CommixTab() }
            else -> { StartTab() }
        }
    }

    fun startAttack(index: Int) {
        launch {
            listExploitTab[index].exploit()
        }
    }

    private fun createSqlmapTab(): SqlmapTab = SqlmapTab(nafService.sqlmapEngine!!)
}
